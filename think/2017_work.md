title: 2017 工作
date: 2018-10-18
updated: 2018-10-19
categories: [think]
tags: [think]
description: 五月至今，工作感想。
---

## 工作

### 孤军奋战

微博移动应用服务接口的重构工作，初期花了一年半时间，搭好了基础的代码框架，有了初步的实现，能在测试环境跑起来了。然后五月来了，负责的「高级工程师」撤退了，我这个「见习工程师」接手。 本以为重构工作能够很快进入了最后的上线冲刺阶段，愿望很美好，现实很残酷。

前任负责人，虽然梳理了旧代码逻辑，写出了清晰简洁的新代码，但是还有许多业务相关的细节没有彻底实现，日志记录、日志转发、请求、身份认证（登录）、参数处理、设置选项、兼容历史问题、代码环境变量设置、Docker 镜像、特殊情况、bug，杂七杂八……

我花了超过两个月，才基本补完了基础代码的细节缺失，填好了林林总总的坑。上班 996（每天 9 点到 21 点，每周 6 天）算个啥，那段时间写代码接近 007（每天 12 点到凌晨，每周 7 天的奇葩作息）。虽然不算持续了太久，有时会少写一点，没有提交，两三周休息个一天或半天。因为急脾气，太想赶紧做完了。

（此处插入 GitLab 总体和 sora 项目的 commits 记录）

### 沟通协作

上一阶段，只要自己好好写代码就够了，GitLab 的 commits 看起来不多，因为更多的是对代码的思考，不需要太多分工合作。毕竟人再多，如果不熟悉代码，也快不起来，还不如我辛苦点赶工做完基础部分。

这一阶段，接口分批上线，需要同事间的沟通协作了。比起写代码，其它琐碎的工作更多了，教实习生、新同事上手，老同事很忙，不够熟悉重构项目，也得帮；还有沟通、讨论琐碎的业务细节处理，有时都说得喉咙痛了。

沟通不是足够简单的事情。为了不重复说同样的话，要费心写好文档，让同事看完文档，再提问，或当别人提问时，告知要看哪一段文档可以得到解答。

沟通之中，不能自说自话，生造一些高大上的词汇，或者云里雾里的部门里的黑话，PM、客户端的黑话，简直恶心人。跟新同事沟通要说明一些名词简称对应的全程，其定义和解释，保证语境和背景知识是尽可能一致，才能让别人明白你在说什么。

说话简洁，不要怕别人听不懂，不记得，不断重复说同样的话，不是别人不记得，而是别人不理解，这时应该想怎样可以更好解释。直接上手写代码，或者指着哪段代码解释，甚至跑起来，抓包查看，然后单步调试，一点点解释清楚。（todo）

### 流程安排

怎么推进重构工作？任务的计划、分解、分配和确认，代码的提交、审核、建议、修改和合并，通过语法检查、漏洞检查、代码风格检查和单元测试，接口 QA 同事对输出结果进行测试，客户端 QA 进行集成（功能）测试，代码和配置在仿真或线上环境的进行上线或回滚，七层配置对接口服务的切换（用 HTTP 层的 nginx），后续的更新或修复……

项目推动者，要制定好合理的工作流程，不断调整大家的工作节奏，计划、通知、确认、执行、提交、反馈，时间点要卡好。不然通知晚了，大家工作就完成得晚，代码就提交得晚，QA 的测试就完成得晚，代码的上线就得晚，相关接口的新旧服务的切换就得晚，如果在周末前的正常工作日没给运维同事留够验证线上服务稳定性的时间，为了避免周末才发现故障以致紧急回滚，就只好等下周继续了，完美地错过了一次服务灰度切换的时间窗口，又要影响下一周的进度……

写好流程的文档说明，想好合适的工作量分配、成果验收、结果反馈的方法，设置合适的时间节点，给运维、QA、自己、同部门的同事们留够时间和空间……一个合理的就花了一个

### 忙碌

突然理解一些老员工为什么发 QQ 信息给他们很久才回复或不见回复，发邮件也是，甚至打电话也不行，只能上门找人，直接在他们跟前排队一个一个等他们解决问题。真忙起来，就是这样。当然我的职责相对简单，没那么忙。

技术开发基本就是执行者，需求方没管理好需求，即使执行者谨慎评估工期、合理地建议并及时拒绝不合理的需求或快速地完成实现，时间还是有限的，处理不过来 —— 多变的需求和无尽的细节调整。或者准确地说，无论效率多快，时间总是会被需求方填满的，所以我们才会常说：工作是做不完的。所以该干嘛干嘛去，要休憩，要学习，要娱乐，要生活。

### 自动化

测试、仿真、线上服务器的上线流程，从 GitLab API、CI 到 Jenkins 构建脚本，通知

教新同事，帮老同事在新项目中查 bug，还有和测试、运维的同事协调解决问题，用 Issue Board 管理项目，然后继续迁移代码，修 bug。事情琐碎、繁杂，不单只动手还要动口沟通，非常费脑子。

### 权力

首先为什么由我主导，而不是老员工？老员工被各种繁杂需求、会议和日常事务缠身，而且都有家室和孩子，没有那么多精力和时间到重构中，只能由深入参与重构、相对年轻、有时间精力、还没离职的我上了。

虽然 boss 现在让我主导这个重构项目，但本质上我是没有什么权力。别说年资，level（职级）、title 都不高，学历只有本科，这些都模糊化，跟其它同事也只能算是平级关系而已。任务还挺繁重的，如果同事们参与程度一般，估计再花个一年半载都不一定能完事，你看，五月到现在都快半年了。

对平级的同事，你不可能像 boss 那样有「强制力」直接指派较繁重的任务。那么自己不但得做好平级间的「管理」，还得处理好日常的业务需求，同时再处理更多繁杂的脏活，身先士卒，身体力行，才能服众，不留给下给他人以偷懒的话柄，以期将其他同事带动起来一起把事情做好。即使同事做得不够多不够好，也不可能指责太多、「颐指气使」、「狐假虎威」。

现在学到管理方面知识的机会实在太多了，但是实际上拥有足够权力的人却很少。手上没有「萝卜或大棒」，说的话没有分量，命令别人干活的强制力都没有，就算不上有权力。这里要解释一下：管理当然不能过分依赖刚说的上下级、甲方乙方之间那种「强制力」，但是它一定是不可或缺的。大家不缺管理方面的知识，就是没有机会施展、实践，更需要争取自己的权力，扩大自己的影响力。

担负责任，才有机会拿到好的绩效，当然也得做出合格的成绩。要么赶紧跑路，要么把手头的工作做好，有始有终。刚工作的第一年也不是没试过「撂挑子」，能力、态度都不行，心理不平衡，绩效不好，都是得过且过、没有出息的结果。

终于有点做小 leader 的感觉了。有领导，就有人被领导，哪有那么多位置，没有比别人强的地方，怎么有资格呆在更高的位置上，还有很远的路要走。

### 管理

涉及更多管理，项目还有人际关系，业务上和技术上都要加倍努力。即使 Boss 赋权让你带好项目，其实你并没有什么权力。你何德何能颐指气使，要别人做这个做那个，只能自己做最累最忙的那个，身先士卒，才能叫得动别人。

然而依然很多人得过且过，不去努力做得更好。这种人肯定存在，推他们一下让他们就只动一下，还是只能尽量督促，看到他们的极限，然后最多只给他们分配稍微超出他们能力和态度的分量。

> 不寄厚望于他人，总要相信只能依靠自己…

然而最近也力不从心了，有时真是怕自己生气、愤怒，心情不好，一不小心将情绪泄到同事那里，那就毁了。
可是太忙了，根本处理不完，需要考虑更高阶的问题了。

这是真的超级感谢之前的自己已经吧效率工具用得比较熟了，处理琐事的效率还是比较高的。
毕竟我操作得比较快。

### 责任感

又有一个同事离职了。其实我很生气。
他并没有把自己烂摊子搞好就走了。
不要以为我在开玩笑，我是认真地想要他把一些烂尾和杂务处理好的。
事实上，我说的话没有任何约束力，他也无心做这些了。
我真的很不开心，我可以理解他的做法，但是我不能接受他的做法。
我觉得很没责任感，最后的推诿，让我极度不爽。
反正之后一生黑，没兴趣再跟他交朋友了。
因为我觉得好没意思。

我是强迫症，只要开始看一本书，就想要看完。同样，我不想工作留下烂摊子。
我要从微博离开，也要带着荣光离开，留下一堆有价值的遗产，而不是烂摊子！
我可以帮助你做好许多工作，但是相对地，如果没有苦衷（比较忙、烦心事、处理脏活），就要被我看不起！
反正道不同不相为谋。

---

工作的日常没有多少「奇遇」，不过每天写 bug 修 bug 罢了，上次还说着不应该再写这种感想而是去写技术文章，还是没忍住。

#### 合作

只要没什么别的想做的事，工作日的晚上、周末基本都拿来赶工了（当然没有加班工资）。只可惜这是一个「长跑」项目，而且依赖分工合作，只靠一个人来做的话，再赶也是遥遥无期。

虽然但是很有成就感，感觉进步很大，感觉自己还是能够克服大的困难，
而不是总是小打小闹，
只能处理非常小规模的问题。

努力努力再努力。
这次如果不是去努力了，
还真以为自己已经是废人了呢。

不要管后面的计划，先把手头的事情做好。
完不成的工作太丢人，我讨厌这样！
强迫症的底线。

完美主义，还要高效率，
只能持续不断地做了。
全心全意解决好一个问题，
不算折磨！

## 组织膨胀

### 迫不得已的烂代码

1 跟公司商业利益相关，不敢动，
    怕出错的后果；

2 其实也能改，但是懒得去做而已，
    没有动力去做这种吃力不讨好的事情，
    毕竟做了也没有更多工资，
    所以没有做优化的动力，
    混吃等死可以，为什么要努力呢？
    boss 不主动挡外来的刀子，
    下面员工谁敢改。

3 而且已经是一坨屎了，要捏着鼻子吃下去，
    然后重新消化（得把它们的逻辑捋清）
    然后非常非常小心修改，
    这个时间成本不小，
    理解难度一点都不低，
    （毕竟有许多
    需要兼容旧版本的历史包袱，业务坑，
    来自内部的项目代码 bug 错误积累，
    冗余的代码，得过且过、低质量的代码）
    所以可能很多人不缺聪明劲，
    却没有耐心直面脏代码！
    一般人更加不愿意，毕竟成本太高了！

（内心想法：
对我来说也是，工资实在太低了，
绩效也不行，真是恶心人。
说是这么说，但是我也撑下来，
重构完这个项目，
所以我就有资格去埋怨这些！
完成不了，这些埋怨就是屁话。）

举个例子：

我就试过重构视频推荐流的接口，
因为实在太屎，
继续往上糊屎（打补丁）来解决问题是可以，但是强迫症的我实在不能忍。
每稍微没隔多长时间，
想要在这上面重新增加特性，
都要重新代码来理解它们的构造，
不然又会改错。
理解成本很高，
需要知道过多的上下文和历史 bug
和业务坑等等…
本来理论上只要代码清晰，
就可以很好改的。

所以我动手把这个接口
（几百行）的代码重写了，
果然百密一疏，还是出 bug 了：
广告的统计需要接口返回数据里的某些字段，但是因为业务代码的复杂性，我还是遗漏了。
瞬间老员工就怂了，
立刻说要把我的提交回滚了；
当然我也怂，
不过我可不想浪费了自己一番辛苦，
找到了问题出在哪之后，赶紧提交了补丁；
因为如果真的回滚了，
估计就没有机会重新重构这段代码，
辛苦就白费了，
还好我的补丁完全解决了问题。

「怕犯错，那就一直糊屎呗！」
其实我已经是非常强迫症的人，
对细节非常认真，很努力地不出错。
但是还是很难避免。
如果公司和 boss 都怕犯点小错误，
不保我这种员工，
那就一直糊屎呗！这种代码腐烂就好，
手动再见，我会主动离开！

登录也是出现过一次被别人刷注册
（注册微博新帐号）的问题，
被发现了漏洞，
跳过了某些认证环节（手机绑定），
我还是坚持使用自己的代码逻辑来改了，
后来同事告诉我，问题解决了。
我真的开心了，
毕竟这次我还是坚持要按我的改法来，
跟同事说明清楚登录的逻辑流程，
说明我的修复优化方法是没有问题的。
我的坚持又一次胜利了。

### 在微博成长的轨迹（埋怨）

毕竟我是工具控，对工具有很强的需求，
还有很多基础知识，我还处在积累期。
来微博的 MAPI 部门，就是看上了它的闲，
可以学习自己想学的东西。

可惜后来我觉得自己选错了，
毕竟人是比较贱的，忙得要死反而珍惜时间，
闲的时候反倒奢侈地浪费，真的进步很慢！
我觉得自己当初该取一个忙碌的地方。
现在也没什么好说的了。

然后新的阶段开始，
假如第一年是让我自由地划水式地成长，
无论如何我也得做出一些成绩回馈公司，
无论如何，我再讨厌这里。
就好像我也并不特别喜欢华工，
但是它仍然是我的母校！

这一年开始了重构，
我开始拼命工作、学习、娱乐。
努力地做事、甚至加班
（我从来周末没事都在公司，
    风雨无阻，毕竟北京很少极端天气）。

终于这半年我终于觉得自己有资格叫板了，
可能我的知识还积累得不够，
可能去外面找比较高要求的工作
还是比较没底气，
但是面对困难的决心，认真的劲头，
对完美代码的追求，
对不懂的地方穷追猛打（穷追不舍），
有勇气面对这些脏代码，我觉得我成长很大。

部门的主项目块头不小，
我终于付出了我的无数努力，
把它变得很好，
如果看不到顺利完全替代旧主项目来上线的那一天，我会「死不瞑目」！

但是我要是真努力起来……
钱不是最重要的，
但是也很重要。

### 臃肿的部门（大企业病）

boss 和老员工都是有家室的人了，
有车有房有孩子，生活很稳定，
收入起码是靠谱的。
特别是 boss 虽然级别不高，
也是有股票的，
不是我们这些底层搬砖码农能比的。

它们这些 boss 有 head count 就会用光，
就算部门没有借口（新业务）来扩张，
为了保证部门不缩小，来保证自己的地位，
肯定还是要用完的，
即使其实我们的部门根本不需要那么多人，
其实要是愿意多给点工资，
部门少一般人都不是事。

但是并不能这样，
毕竟大家都知道项目架构
特别 Web 这类型都要避免「单点故障」，
企业也是这样子的，部门也是这个样子的。

当然一个人稀缺性和不可替代性越强，
议价能力就越强。
实际上企业不见得这样，
它们希望每个岗位都是
可以随便找到足够的人替代，
毕竟公司就是盈利型组织
（要时刻谨记这一点啊！），
员工当然要有足够的替代性才行，
所以要招足够多的人，来冗余性能功能，
避免出问题。
企业发展不能受制于部分的人才流失才行。

就是因为以上 boss 不希望自己的部门
越来越小，
公司不希望发生「单点故障」，
也是倾向于「臃肿」，
拥有冗余的人力、物力、人才等等。

所以没有办法，我个人还是好好努力吧！

## 脏代码

工作越久越意识到脏代码的不可避免。
还要看脏到什么程度，
可是一点脑子都不带的代码，我还是不能忍！
我真的觉得，不一定是因为写代码的人不懂，
只是他们没有动力去做这种努力而已。
还好我的工作比较闲，可以追求代码质量。

我有时写代码做需求做得比较久，
就是因为我追求完美的代码，
只要我觉得还能更好，我就不会停歇，
而是不断钻研。

##

昨天研究了一天 Guzzle/Promise 的运行… 概念上有了粗浅的理解，可是看具体的代码实现时，虽然也有了一定成都的理解，但明显还是蒙逼的…// 面向「单步调试」编程毕竟不是万能，有时还是面向「打印」编程靠谱点（充分理解尚需时日，不敢奢求）。刚开始单步调试打断点的时候，执行怎么大多数调用老是失败（rejected）（通常只有其中一个请求成功 fullfiled），回调（then）的流程好像不符合预期。后来才反应过来，单步断点观察执行上下文的时间太长了，影响了异步执行的逻辑（tick）… 不设断点，异步请求打出来的日志都是正确的，我终于「投翔」了。异步请求返回的结果也能有正常正确的日志就够了…

心态爆炸了，代码+业务的上下文快装不下了，细节多了，自己也想得多了，脑子短路，自己都绕进去了。整了才知道着这么多技术还是业务上的细节不清楚，毕竟平时用不到…（越想越不对，一些日志很随意就写了，稍一不注意就写了一堆没用的日志到线上机器上了…  还有一堆根本没必要推送 syslog 的日志… 今天才反应过来。）不能忍了，连续每天写，要是写到端午那天就两周了，放假之后要是还不能上线，我自己都要受不了了… [哆啦A梦微笑]

我这一周来，每天总会产生一种幻觉，我快弄好了… 然而一次一次一次… 又一次发现了新的问题。 ​​​

我在翔海里傲游，试图找到其中的线索… 所以才想走改良主义，先在原来的代码动刀子，理清代码，发现没岔子，才敢再重构它。不然直接重构后，代码面目全非了，构造沧海桑田，回看原来的代码，基本没法一眼找出线索，结果还是得重新整理一遍，看着到底哪里对应的哪里，补丁+copy/paste再改一改到处都是… 不然又掉坑里了。

如果状态不重要的话，我就不会每晚这么晚睡了，毕竟进入状态不容易。起床的时候通常精神状态还不错，但如果真的要开始做点什么，才发现我不想做，哪怕是昨天状态再灼热… 非做不可或者重要但是不紧迫，就得花点时间强迫自己做一会，想只花 5 分钟是想多了，有时一两个小时还是要的，直到自己慢慢感觉不到厌恶和疲惫了（忘我）… 回过神来，才发现自己总算进入了状态，接下来就驾轻就熟，如入无人之境了，然而正常的一天，也快结束了，然后迎来了午夜。

##

Log::write()（
    日志记录所需的材料先包装好，一条一条写到一个数组（或者说是队列）里，
    然后集中开始 Logger::info(record) 来记录日志
）-> LoggerFactory::getLogger(log_module_name) （先得用它来获得 Logger）
-> Logger（属于同一 module 的日志可以复用专属的 Logger 单例）
-> Processors 和 Handlers（
    当然我们有我们的 ProcessorCreator 和 HandlerCreator 来创建它们。
    每条日志经过各种 eachProcessor->process() 之后，
    然后进行各种 eachHandler->handle()：
        2.1 Handler 也可以有自己的一堆 Processors
            又一轮 eachProcessor->process()…
        2.2 每个 Handler 自带一个 Formatter，
            来吧 $this->getFormatter()->format() 格式化日志…
        2.3  write() 日志终于要落地，来吧根据路径模板 initialUrl 来生成路径 url
            由于 每次 url 不尽相同，File stream 不断 close，生成新路径，然后重新打开
）-> 配置文件 *.ini（
    说明有哪些 modules 的日志们，它们需要用到哪些 processors、handlers，
    其中每个 handler 又用哪个 formattor，日志级别…
）-> 相关配置先处理一下（格式化），然后 configure(config) 一下，
    将配置传到 LoggerFactory 就好了…

就 syslog 的记录，可能会用 openlog() & syslog() 来记；
或者传出去，如果长度短用 tcp，长度长可以用 udp 传出去。
就这里就可以拆出三个 handlers：
SyslogHandler http://t.cn/RaRuMPA 、
SyslogUdpHandler http://t.cn/RaRuMPZ 、
SocketHandler http://t.cn/RaRu9y2

来最后让我们看看我们可能要用的 processor 之一 UidProcessor？？？？
（看到 Monolog 这封装示例也是服了职责切分得够细的）
看了 http://t.cn/RaRuMPw 文档，可以说相当地好，
虽然符合具体需求和能用到的没几个，不过拓展性灵活性可以说相当滴好…
在 Monolog 上我们再给它再封装、拓展了一下，能符合我们的需求就好了…

感觉 [二哈] 生成一条日志老费劲了。真是很好的设计模式练习呢

## 重构项目的尴尬

- 老人对重构后的项目蒙逼。
- 引入魔术方法、分层、以来项目，写代码门槛变高了。
    - 熟悉新东西，还是比较困难的。
    - 别说老同事，我也是；毕竟我也是连续每天看代码写代码一个月才熟悉得七七八八
        - 不敢说明白了，毕竟不知道什么时候就掉进坑里了
        - 只能说改变是很痛苦的
- 不是所有项目在同一个项目里，不好维护。
- 不用 IDE，用 Vim 更蒙逼。
- IDE 也不是万能的，类型推导也会出问题。
- 你到底想要怎样的项目？
    - 冗余很低，但是不容易理解和维护。
    - 适度的冗余，保证容易理解？怎样算容易理解？
        每个人的理解不一致，都有自己的标准；这就很尴尬了。

##

配一遍 GitLab CI Runner 就能知道怎么能让它跑得更快了（改了一些 Runner 的配置选项、修整 Docker 镜像和运行环境）// 用 Symfony 的 Console\Command 写了指令，才比较清楚，那些命令行帮助手册（man cmd_name）里的各种提示是在写什么鬼… // 先把基础指令和脚本都写完，简单的自动化就用 crontab -e 写一行指令跑个定时任务好了… 自动仿真上线，然后清理多余的过期仿真包 tag …

##

之前咋这么智障，用 bash 脚本来实现「上线 tag 包的 release notes 回写」… 用 Symfony\Component\Console\Command\Command 来写指令不就完了么… ​​​​

##

比起项目上一个阶段，很多时候不是静静写好自己的代码能够解决的。更接近 Project Management 了，非紧急的 Debug 和写代码只能晚上和周末。代码审核没空再手下留情了，之前还时不时为了赶时间合并之后自己动手修正。常在河边走哪有不湿鞋，偶尔脑子短路指不定就写 bug 了，只能求神保佑故障了。 ​​​​

##

自己坑完，部门同事坑，然后运维坑，然后沟通坑，总之互相坑…… 都习惯了。被坑得最多的 QA 同事，因为仿真上线流程配错了一个设置，她们又白测了一下午了…… ​​​​

##

想自己配置一个能跑新项目 CI 流程的 GitLab-Runner，昨天折腾得大半天，今天请教运维后再弄，还是没成功。我受不了了，只好作罢…… 原来用运维配的 Runner 能有 50 concurrent jobs，那我还是歇歇吧，试着用于就不错了。这玩意真是搞得心情不好（总是配置不好，令人崩溃），真想赶紧到周末转换一下心情。// no basic auth crendentials 到底是什么鬼，不是已经有 docker login 后的登录信息了么？难道要我在 .gitlab-ci.yml 的 before_script 加上 `docker login -u username -p $PWD url/to/docker/image` ？

##

今天某其它公司的 PM 朋友吐槽一个开发同事，没法按时完成任务了，聊着聊着一言不合，怒删微信好友… 想起一年前处理某件事的做法我也不够地道，即使实在能力不够爱莫能助了，也不能发脾气（失去耐心和足够友好的态度…）。当时仅有的两三个相关人员，如我回原组，另一个离职，剩下 PM 一脸蒙逼。当时这个问题折腾了非常非常久，我也崩溃了，实在想不到坑在哪，不是我不想解决问题，我也很绝望啊，我认怂了行不？可惜当时没有好好装孙子。后来，他们好像后来换了人也没有解决这个问题（好吧），似乎换了种不太合理的方式解决（毕竟可能是原有的体系有坑，所以一直没解决）。然后这个 PM 再也没找过我处理他们的需求（难免…），当然我付出了代价，不过相应的好处便是他们的需求就没再出现在我邮件里了，然后接下来一年我安安心心做主项目重构去了……

##

用文档把描述得清清楚楚还是不够（假设写得足够清楚），但是大家都忙，而且也懒，往往不会细看，这再正常不过了。所以知识还是得先靠口口相传，写好文档的作用是：当大家问起相关问题的时候，知情人就可以说文档里的某个部分有相关的答案，自己去看，有问题再问…

##



